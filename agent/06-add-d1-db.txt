

1. Create d1 in cloudflare, this will generate a new id
```
npx wrangler d1 create <db_name>
```

2. Update wrangler.toml  with the generated id from terminal
```
[[d1_databases]]
binding = "DB"
database_name = "<db_name>"
database_id = "<new_id>"
```

3. Create first migration, this will generate a new file in migrations folder
```
npx wrangler d1 migrations create <db_name> create_settings_table
```

4. Update the generated migration file to add Table schema following the example below
```
CREATE TABLE settings (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    key TEXT NOT NULL,
    value TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

5. Apply migration locally
```
npx wrangler d1 migrations apply <db_name> --local
```

6. Add d1 typings 
env.d.ts
```
// Generated by Wrangler
// by running `wrangler types --env-interface CloudflareEnv env.d.ts`

interface CloudflareEnv {
  DB: D1Database;
}
```

6. Create a d1 services file to use d1 database
file: server/infrastructure/d1.ts
```
/* eslint-disable @typescript-eslint/no-explicit-any */
import { getRequestContext } from "@cloudflare/next-on-pages";

export const runtime = "edge";

export function getDb() {
  return getRequestContext().env.DB;
}

export async function executeQuery<T>(query: string, bind: any[] = []) {
  const db = getDb();
  const stmt = db.prepare(query).bind(...bind);
  const { results } = await stmt.all<T>();
  return results;
}

export async function runQuery<T>(query: string, bind: any[] = []) {
  const db = getDb();
  const stmt = db.prepare(query).bind(...bind);
  const { results } = await stmt.run<T>();
  return results;
} 
```

7. Create a new service file for settings Model, this will be used to create, read, update and delete settings, user_id will be used to identify the user
file: server/domain/settings.ts


7. Add d1 services file to server/infrastructure/index.ts
```
export * from "./d1";
```

8. Create API endpoints for settings Model
routes:
- GET /api/settings
- POST /api/settings
- PUT /api/settings/:id
- DELETE /api/settings/:id

info: for getting user_id use 
```
import { getSession } from '@auth0/nextjs-auth0/edge';

  const session = await getSession();
  const userId = session?.user.sub;
```

9. create a api-test.http file to test the api
file: api-db-test.http
```
@token=appSession=abc

###
Get http://localhost:3000/api/settings
Cookie: {{token}}


###
POST http://localhost:3000/api/settings
Cookie: {{token}}

{
    "key": "test",
    "value": "test"
}

###
@keyId=xyz
Put http://localhost:3000/api/settings/{{keyId}}
Cookie: {{token}}

{
    "key": "test2",
    "value": "test2"
}

###
Delete http://localhost:3000/api/settings/{{keyId}}
Cookie: {{token}}
```